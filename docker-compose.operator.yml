# QuantumHarmony Node - Simple Operator Setup
# Just the node + dashboard - no KYC/DB services
#
# Usage: docker-compose -f docker-compose.operator.yml up

services:
  node:
    image: sylvaincormier/quantumharmony-node:v28.1-issues
    platform: linux/amd64
    container_name: quantumharmony-node
    restart: unless-stopped
    user: "0:0"
    ports:
      - "9944:9944"
      - "30333:30333"
      - "9615:9615"
    volumes:
      - node-data:/data
      - ./configs/chain-spec.json:/config/chainspec.json:ro
    entrypoint: ["/usr/local/bin/quantumharmony-node"]
    command:
      - "--chain=/config/chainspec.json"
      - "--sync=full"
      - "--base-path=/data"
      - "--name=${NODE_NAME:-Operator}"
      - "--rpc-external"
      - "--rpc-cors=all"
      - "--rpc-methods=Unsafe"
      - "--rpc-port=9944"
      - "--port=30333"
      - "--prometheus-port=9615"
      - "--prometheus-external"
      - "--database=paritydb"
      - "--bootnodes=/ip4/51.79.26.123/tcp/30333/p2p/12D3KooWEyoppNCUx8Yx66oV9fJnriXwCcXwDDUA2kj6vnc6iDEp"
      - "--bootnodes=/ip4/51.79.26.168/tcp/30333/p2p/12D3KooWHdiAxVd8uMQR1hGWXccidmfCwLqcMpGwR6QcTP6QRMuD"
      - "--bootnodes=/ip4/209.38.225.4/tcp/30333/p2p/12D3KooWSCufgHzV4fCwRijfH2k3abrpAJxTKxEvN1FDuRXA2U9x"
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:9944/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s

  dashboard:
    image: nginx:alpine
    container_name: quantumharmony-dashboard
    restart: unless-stopped
    ports:
      - "8080:80"
    volumes:
      - ./dashboard:/usr/share/nginx/html:ro
      - ./configs/nginx-dashboard.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - node

  updater:
    build: ./updater
    container_name: quantumharmony-updater
    restart: unless-stopped
    environment:
      - IMAGE=sylvaincormier/quantumharmony-node
      - IMAGE_TAG=v28.1-issues
      - UPDATE_INTERVAL=86400
      - MONITOR_INTERVAL=60
      - HEALTH_TIMEOUT=180
      - HEALTH_URL=http://localhost:9944/health
      - NODE_CONTAINER=quantumharmony-node
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    network_mode: host
    depends_on:
      - node

  # Safe Docker API access for agent
  docker-socket-proxy:
    image: tecnativa/docker-socket-proxy:0.3
    container_name: quantumharmony-docker-proxy
    restart: unless-stopped
    environment:
      - CONTAINERS=1
      - IMAGES=0
      - NETWORKS=0
      - VOLUMES=0
      - POST=1
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro

  # qh-agent autonomous monitoring & remediation
  agent:
    image: sylvaincormier/qh-agent:m2.6
    container_name: quantumharmony-agent
    restart: unless-stopped
    ports:
      - "8090:8090"
    volumes:
      - agent-data:/data
      - ./configs/operator-agent.toml:/config/qh-agent.toml:ro
    environment:
      - DOCKER_HOST=tcp://docker-socket-proxy:2375
      - QH_AGENT_NAME=${NODE_NAME:-Operator}-agent
      - QH_NETWORK=quantumharmony
    depends_on:
      - node
      - docker-socket-proxy

networks:
  default:
    driver: bridge

volumes:
  node-data:
  agent-data:
