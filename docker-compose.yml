# QuantumHarmony Node Operator
# One-command deployment for node operators
#
# Production Validators (Updated 2026-01-28):
#   - Validator 1 (Alice/Montreal):    51.79.26.123  - 12D3KooWLmphH9JtAVntVnZ4fZ5keJSjKEyWFANcKVzWVLnwVe9Z
#   - Validator 2 (Bob/Beauharnois):   51.79.26.168  - 12D3KooWGiDT7jsuqFJhsvoN4KZp8KZ5CjtUnEvRxUNVNvLRwnFA (PRIMARY DB)
#   - Validator 3 (Charlie/Frankfurt): 209.38.225.4  - 12D3KooWRzTbwny8fUNUZQvS24RJWj44RSivgCQNN6Bb6WwhTQNh
#
# Usage:
#   docker-compose up -d
#   docker-compose logs -f node
#
# Database:
#   Primary PostgreSQL on Bob, streaming replicas on Alice/Charlie
#   Stores encrypted KYC documents (passport, biometric helper data)

services:
  # =====================================================
  # CORE: QuantumHarmony Blockchain Node
  # =====================================================
  node:
    image: sylvaincormier/quantumharmony-node:arm64
    #platform: linux/amd64  # Commented - causes crypto issues under emulation on ARM Macs
    # Includes: forum module, SPHINCS+ signatures, all pallets
    container_name: quantumharmony-node
    restart: unless-stopped
    user: "0:0"
    ports:
      - "127.0.0.1:9944:9944"   # RPC/WebSocket (localhost only â€” nginx proxies external)
      - "30333:30333" # P2P
      - "9615:9615"   # Prometheus metrics
    volumes:
      - node-data:/data
      - ./configs/chain-spec.json:/config/chainspec.json:ro
      # - /home/ubuntu/validator-key.json:/config/validator-key.json:ro  # Production only
    command:
      - "--chain=/config/chainspec.json"
      # - "--validator"  # Enable only if you have validator keys
      - "--sync=full"
      - "--base-path=/data"
      - "--name=${NODE_NAME:-Operator}"
      - "--rpc-external"
      - "--rpc-cors=all"
      - "--rpc-methods=Safe"
      - "--bootnodes=/ip4/51.79.26.123/tcp/30333/p2p/12D3KooWLmphH9JtAVntVnZ4fZ5keJSjKEyWFANcKVzWVLnwVe9Z"
      - "--bootnodes=/ip4/51.79.26.168/tcp/30333/p2p/12D3KooWGiDT7jsuqFJhsvoN4KZp8KZ5CjtUnEvRxUNVNvLRwnFA"
      - "--bootnodes=/ip4/209.38.225.4/tcp/30333/p2p/12D3KooWRzTbwny8fUNUZQvS24RJWj44RSivgCQNN6Bb6WwhTQNh"
      # Node generates unique identity on first run (stored in /data)
    environment:
      - NODE_NAME=${NODE_NAME:-Operator}
      - RPC_METHODS=Safe
      # - VALIDATOR_KEY_FILE=/config/validator-key.json  # Enable only for validators
    networks:
      - quantum-net
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:9944/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # =====================================================
  # POSTGRES: KYC Document Storage (Primary on Bob)
  # =====================================================
  postgres:
    image: postgres:16-alpine
    container_name: quantumharmony-postgres
    restart: unless-stopped
    ports:
      - "127.0.0.1:5432:5432"
    environment:
      POSTGRES_DB: quantumharmony
      POSTGRES_USER: qh_admin
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD must be set}
      REPLICATOR_PASSWORD: ${REPLICATOR_PASSWORD:?REPLICATOR_PASSWORD must be set}
      # Replication settings (for primary)
      POSTGRES_INITDB_ARGS: "--data-checksums"
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./configs/postgres/init.sql:/docker-entrypoint-initdb.d/01-init.sql:ro
      - ./configs/postgres/00-set-replicator-password.sh:/docker-entrypoint-initdb.d/00-set-replicator-password.sh:ro
      - ./configs/postgres/primary.conf:/etc/postgresql/conf.d/primary.conf:ro
    command:
      - "postgres"
      - "-c"
      - "config_file=/etc/postgresql/conf.d/primary.conf"
    networks:
      - quantum-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U qh_admin -d quantumharmony"]
      interval: 10s
      timeout: 5s
      retries: 5

  # =====================================================
  # KYC-API: REST API for KYC Document Management
  # =====================================================
  kyc-api:
    image: sylvaincormier/quantumharmony-kyc-api:latest
    container_name: quantumharmony-kyc-api
    restart: unless-stopped
    ports:
      - "127.0.0.1:8200:8200"
    environment:
      - DATABASE_URL=postgresql://qh_admin:${POSTGRES_PASSWORD}@postgres:5432/quantumharmony
      - KYC_API_KEY=${KYC_API_KEY}
      - RUST_LOG=info
      - ENCRYPTION_KEY=${KYC_ENCRYPTION_KEY:-}
      - IPFS_GATEWAY=https://gateway.pinata.cloud/ipfs
      - NODE_RPC=http://node:9944
    networks:
      - quantum-net
    depends_on:
      postgres:
        condition: service_healthy
      node:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8200/health"]
      interval: 30s
      timeout: 5s
      retries: 3

  # =====================================================
  # CRYPTO4A-SIMULATOR: QRNG Entropy Source
  # =====================================================
  crypto4a-simulator:
    image: sylvaincormier/quantumharmony-crypto4a:latest
    container_name: quantumharmony-crypto4a
    restart: unless-stopped
    ports:
      - "8106:8106"
    environment:
      - PORT=8106
    networks:
      - quantum-net
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8106/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  # =====================================================
  # OPERATOR: PQ-Encrypted Messaging Service
  # =====================================================
  operator:
    image: sylvaincormier/quantumharmony-node-operator:latest
    container_name: quantumharmony-operator
    restart: unless-stopped
    ports:
      - "9955:9955"
    volumes:
      - operator-data:/data
    environment:
      - OPERATOR_PORT=9955
      - DATA_DIR=/data
      - RPC_URL=http://node:9944
      - ALLOW_UNAUTHENTICATED=true
    networks:
      - quantum-net
    depends_on:
      - node
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:9955/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  # =====================================================
  # FAUCET: Token Drip Service
  # =====================================================
  faucet:
    image: sylvaincormier/quantumharmony-faucet:latest
    container_name: quantumharmony-faucet
    restart: unless-stopped
    ports:
      - "127.0.0.1:8085:8085"
    environment:
      - FAUCET_PORT=8085
      - RPC_URL=ws://node:9944
      - DRIP_AMOUNT=100000000000000000000
      - COOLDOWN_MS=60000
    networks:
      - quantum-net
    depends_on:
      node:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8085/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s

  # =====================================================
  # DASHBOARD: Notarial Service Web UI (LCARS)
  # =====================================================
  dashboard:
    image: sylvaincormier/quantumharmony-dashboard:latest
    container_name: quantumharmony-dashboard
    restart: unless-stopped
    ports:
      - "8080:80"
    volumes:
      - ./configs/nginx-dashboard.conf:/etc/nginx/conf.d/default.conf:ro
      - ./dashboard/index.html:/usr/share/nginx/html/index.html:ro
      - ./notarial/lcars.html:/usr/share/nginx/html/lcars.html:ro
      - ./notarial/app.html:/usr/share/nginx/html/app.html:ro
      - ./notarial/index-lcars.html:/usr/share/nginx/html/index-lcars.html:ro
      - ./notarial/js:/usr/share/nginx/html/js:ro
    networks:
      - quantum-net
    depends_on:
      - node

  # =====================================================
  # PROXY: Nginx Reverse Proxy with SSL
  # =====================================================
  nginx:
    image: nginx:alpine
    container_name: quantumharmony-proxy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./configs/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./certs:/etc/nginx/certs:ro
      # Production-only paths (comment out for local dev):
      # - /home/ubuntu/paraxiom-site:/var/www/paraxiom:ro
      # - /home/ubuntu/quantum-simulations:/var/www/simulations:ro
      # - /var/www/html/jacynthe:/var/www/jacinthe:ro
    networks:
      - quantum-net
    depends_on:
      - node
      - dashboard
      - kyc-api
      - faucet

networks:
  quantum-net:
    driver: bridge

volumes:
  node-data:
  postgres-data:
  operator-data:
